#!/bin/bash
# Copyright 2025 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

set -o errexit
set -o nounset

DEVKIT="$(dirname -- "$(readlink -f -- "${BASH_SOURCE[0]}")")"
readonly DEVKIT

readonly SCRIPTS="${DEVKIT}/../scripts"
readonly IMAGES="${DEVKIT}/../images"

source "${SCRIPTS}/lib_logging.sh"

function usage() {
  declare -r -i exitval=${1-1}
  cat <<USAGE
usage: $(basename "${BASH_SOURCE[0]}") --dir <directory> [--config <file>] [--load] [image_name ...]

Vendors (saves) or loads Docker images.

options:
  -h, --help            Show this help message and exit.
  --dir <directory>     Directory to save images to or load images from.
  --config <file>       Path to devkit.json config file. Defaults to devkit.json in the project root.
  --load                Load images from the directory instead of saving.
USAGE
  exit ${exitval}
}

declare DIR=""
declare CONFIG=""
declare -i LOAD=0
declare -a IMAGES_TO_PROCESS=()

while [[ $# -gt 0 ]]; do
  case "$1" in
    --dir)
      if [[ $# -lt 2 ]]; then
        echo "Error: --dir requires an argument." >&2
        usage 1
      fi
      DIR="$2"
      shift 2
      ;;
    --config)
      if [[ $# -lt 2 ]]; then
        echo "Error: --config requires an argument." >&2
        usage 1
      fi
      CONFIG="$2"
      shift 2
      ;;
    --load)
      LOAD=1
      shift
      ;;
    -h | --help)
      usage 0
      ;;
    -*)
      echo "Error: Unknown option: $1" >&2
      usage 1
      ;;
    *)
      IMAGES_TO_PROCESS+=("$1")
      shift
      ;;
  esac
done

function save_image_to_file() {
  declare dir="$1"
  declare tag="$2"

  # Create directory structure mirroring the tag
  declare -r output_file="${dir}/${tag}.tar"
  mkdir -p "$(dirname "${output_file}")"

  printf "Saving %s to %s...\n" "${tag}" "${output_file}"
  docker save --output "${output_file}" "${tag}"
}

if [[ -z "${DIR}" ]]; then
  echo "Error: --dir is required." >&2
  usage 1
fi

if [[ -z "${CONFIG}" ]]; then
  PROJECT_ROOT="$("${SCRIPTS}"/find_project_root.py)"
  readonly PROJECT_ROOT
  CONFIG="${PROJECT_ROOT}/devkit.json"
fi

if [[ ${LOAD} -eq 1 ]]; then
  if [[ ${#IMAGES_TO_PROCESS[@]} -gt 0 ]]; then
    echo "Error: Cannot specify image names when using --load." >&2
    usage 1
  fi

  if [[ ! -d "${DIR}" ]]; then
    echo "Error: Directory ${DIR} does not exist." >&2
    exit 1
  fi

  echo "Loading images from ${DIR}..."
  count=0
  # Use find to locate all tar files recursively
  while IFS= read -r archive; do
    echo "Loading ${archive}..."
    docker load --input "${archive}"
    count=$((count + 1))
  done < <(find "${DIR}" -type f -name "*.tar")

  if [[ ${count} -eq 0 ]]; then
    echo "No .tar files found in ${DIR}."
  else
    echo "Successfully loaded ${count} images."
  fi

else
  if [[ ${#IMAGES_TO_PROCESS[@]} -eq 0 ]]; then
    echo "Error: No images specified to vendor." >&2
    usage 1
  fi

  mkdir -p "${DIR}"

  for image in "${IMAGES_TO_PROCESS[@]}"; do
    echo "Processing ${image}..."

    # We rely on build.py to ensure the image exists (build or pull) and give us the correct tag.
    # Note: build.py writes logs to DEVKIT_LOG_FILE if set, or stderr.
    # We capture stdout for the tag.
    TAG=$("${SCRIPTS}/docker/build.py" "${image}" \
      --print-tag \
      --search-path "${IMAGES}" \
      --log-file "${DEVKIT_LOG_FILE:-/dev/null}" \
      --config "${CONFIG}") || {
      echo "Error: Failed to resolve tag for ${image}. Check build logs." >&2
      exit 1
    }

    if [[ -z "${TAG}" ]]; then
      echo "Error: build.py returned empty tag for ${image}." >&2
      exit 1
    fi

    echo "Resolved tag: ${TAG}"
    save_image_to_file "${DIR}" "${TAG}"
  done

  echo "Successfully vendored ${#IMAGES_TO_PROCESS[@]} images to ${DIR}."
fi
